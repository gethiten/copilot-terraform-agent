# Copilot Terraform Agent

ğŸ¤– Backend actions for Copilot Studio agent that generates Azure Terraform code

## Overview

This is a lightweight backend API for Microsoft Copilot Studio. **Copilot Studio handles all AI/Terraform generation** using its built-in GPT capabilities. This backend simply provides actions to commit code to GitHub and create Pull Requests.

**No Azure OpenAI or Foundry dependency required!**

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Copilot Studio (Teams/Web)           â”‚
â”‚   - Built-in GPT generates Terraform   â”‚
â”‚   - Conversational UI                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   This Backend API (Flask)             â”‚
â”‚   - Receives generated Terraform code  â”‚
â”‚   - Commits to GitHub                  â”‚
â”‚   - Creates Pull Requests              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   GitHub Repository                    â”‚
â”‚   - Review PR                          â”‚
â”‚   - Merge to deploy                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Benefits

| Feature | This App (Copilot Studio Native) |
|---------|----------------------------------|
| AI Backend | Copilot Studio's built-in GPT (no extra cost) |
| Dependencies | Minimal (flask, requests only) |
| Azure OpenAI | Not required |
| Foundry | Not required |
| Use Case | Teams integration, conversational UI |

## Two-App Deployment

This is a **separate deployment** from the Foundry Agent app. You can run both side-by-side:

| App | Resource Group | AI Backend | Use Case |
|-----|----------------|------------|----------|
| **Foundry Agent** | `rg-foundry-terraform` | Azure AI Foundry + Azure OpenAI | Custom web app, agent tools |
| **Copilot Agent** (this) | `rg-copilot-terraform` | Copilot Studio GPT | Teams, conversational UI |

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         YOUR AZURE SUBSCRIPTION                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  rg-foundry-terraform           â”‚  rg-copilot-terraform                     â”‚
â”‚  â”œâ”€â”€ App Service                â”‚  â”œâ”€â”€ App Service                          â”‚
â”‚  â”œâ”€â”€ Azure OpenAI               â”‚  â””â”€â”€ (No Azure OpenAI needed)             â”‚
â”‚  â””â”€â”€ AI Foundry Project         â”‚                                           â”‚
â”‚                                 â”‚  Uses: Copilot Studio built-in GPT        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Quick Start

### 1. Clone and Setup

```bash
# Clone repository
git clone https://github.com/gethiten/copilot-terraform-agent.git
cd copilot-terraform-agent

# Create virtual environment
python -m venv venv
.\venv\Scripts\Activate.ps1  # Windows
# source venv/bin/activate   # Linux/Mac

# Install dependencies
pip install -r requirements.txt
```

### 2. Configure Environment

```bash
# Copy example config
copy .env.example .env

# Edit with your values
notepad .env
```

Required settings:
- `GITHUB_TOKEN` - GitHub personal access token (for creating PRs)
- `GITHUB_REPO_URL` - Your repository URL

**Note:** No Azure OpenAI settings needed! Copilot Studio handles AI generation.

### 3. Run Locally

```bash
python app.py
```

Open http://localhost:5001 in your browser.

### 4. Test the API

```bash
# Health check
curl http://localhost:5001/api/health

# Commit Terraform (code generated by Copilot Studio)
curl -X POST http://localhost:5001/api/copilot/generate \
  -H "Content-Type: application/json" \
  -d '{"terraform_code": "terraform { ... }", "description": "Create a storage account", "location": "eastus"}'
```

## API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/health` | GET | Health check |
| `/api/copilot/generate` | POST | Commit Terraform code to GitHub (receives code from Copilot Studio) |
| `/api/copilot/status/{pr}` | GET | Check PR status |
| `/api/templates` | GET | List available templates |

## Copilot Studio Integration

### 1. Deploy to Azure (New Resource Group)

```bash
# Create NEW resource group (separate from Foundry app)
az group create --name rg-copilot-terraform --location eastus

# Create App Service plan
az appservice plan create --name plan-copilot-terraform \
  --resource-group rg-copilot-terraform \
  --sku B1 --is-linux

# Create App Service
az webapp create --name copilot-terraform-agent \
  --resource-group rg-copilot-terraform \
  --plan plan-copilot-terraform \
  --runtime "PYTHON:3.11"

# Configure settings (only GitHub - no Azure OpenAI needed!)
az webapp config appsettings set --name copilot-terraform-agent \
  --resource-group rg-copilot-terraform \
  --settings GITHUB_TOKEN=ghp_xxx GITHUB_REPO_URL=https://github.com/your-org/terraform-repo
```

### 2. Add Action to Copilot Studio

1. Go to [Copilot Studio](https://copilotstudio.microsoft.com)
2. Create new agent
3. Go to **Actions** â†’ **+ Add an action** â†’ **Connector action**
4. Import `docs/copilot-openapi.json`
5. Configure host to your App Service URL
6. Add instructions to agent (see setup guide)

**No Power Automate flows needed!** The agent calls your API directly via Actions.

See [COPILOT_STUDIO_SETUP.md](docs/COPILOT_STUDIO_SETUP.md) for detailed instructions.

## Files

```
copilot-terraform-agent/
â”œâ”€â”€ app.py                    # Main Flask application
â”œâ”€â”€ requirements.txt          # Python dependencies
â”œâ”€â”€ .env.example             # Environment template
â”œâ”€â”€ .gitignore               # Git ignore rules
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ index.html           # Web interface
â””â”€â”€ docs/
    â”œâ”€â”€ copilot-openapi.json # OpenAPI spec for Actions
    â””â”€â”€ COPILOT_STUDIO_SETUP.md # Detailed setup guide
```

## License

MIT
